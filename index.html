<!DOCTYPE html>
<html>
<head>
    <title>ACCC Merger Survey</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .survey-form {
            margin: 20px;
            text-align: center;
        }
        input[type="number"] {
            padding: 8px;
            margin: 10px;
            width: 120px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background-color: #4682B4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #357599;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .chart-container {
            width: 600px;
            height: 400px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #error {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="survey-form">
        <h2>How many mergers will be notified to the ACCC under the new regime in 2026?</h2>
        <input type="number" id="answer" min="0" required>
        <button id="submitButton" onclick="submitAnswer()" disabled>Submit</button>
        <div id="error"></div>
    </div>
    <div class="chart-container">
        <canvas id="chart"></canvas>
    </div>

    <script>
        let chart;
        let buckets = [];
        let hasSubmitted = false;

        async function initializeChart() {
            try {
                const response = await fetch('https://cardioid.co.nz/api/get_votes');
                const data = await response.json();
                if (data.status !== "success") throw new Error("Failed to get votes");
                
                buckets = data.votes;
                document.getElementById('submitButton').disabled = false;
                
                const ctx = document.getElementById('chart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (chart) {
                    chart.destroy();
                }
                
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: buckets.map(b => b.bucket),
                        datasets: [{
                            data: hasSubmitted ? buckets.map(b => b.n) : Array(buckets.length).fill(0),
                            backgroundColor: 'rgba(70, 130, 180, 0.8)',
                            borderColor: 'rgba(70, 130, 180, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 750,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    display: false
                                },
                                border: {
                                    display: true,
                                    color: 'black',
                                    width: 2
                                },
                                ticks: {
                                    display: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                document.getElementById('error').textContent = 'Failed to load data';
                console.error('Error:', error);
            }
        }

        function getBucketIndex(value) {
            if (!buckets || buckets.length === 0) return -1;
            
            return buckets.findIndex(bucket => {
                const range = bucket.range;
                if (range.endsWith('+')) {
                    return value >= parseInt(range);
                }
                const [min, max] = range.split('-').map(Number);
                return value >= min && value <= max;
            });
        }

        async function submitAnswer() {
            const answer = document.getElementById('answer').value;
            if (!answer) return;

            const bucketIndex = getBucketIndex(parseInt(answer));
            if (bucketIndex === -1) {
                document.getElementById('error').textContent = 'Invalid answer range';
                return;
            }

            try {
                const voteData = {
                    vote: parseInt(answer),
                    timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
                };
                
                const response = await fetch('https://cardioid.co.nz/api/submit_vote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        vote_base64: btoa(JSON.stringify(voteData))
                    })
                });

                if (!response.ok) throw new Error('Failed to submit vote');

                hasSubmitted = true;
                // Refresh chart
                await initializeChart();
                
                document.getElementById('answer').value = '';
                document.getElementById('error').textContent = '';
            } catch (error) {
                document.getElementById('error').textContent = 'Failed to submit vote';
                console.error('Error:', error);
            }
        }

        initializeChart();
    </script>
</body>
</html>
